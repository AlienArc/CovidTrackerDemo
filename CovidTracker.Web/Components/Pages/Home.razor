@page "/{PageDateFilter:datetime?}"
@inherits ViewModelComponentBase<HomeViewModel>

<PageTitle>Covid Tracker</PageTitle>

<MudStack>
    <MudText Typo="Typo.h3">Covid statistics by State</MudText>

    <MudDataGrid @ref="_dataGrid" Loading="_loading" T="StateDailyTotalViewModel" Items="@ViewModel.DailyTotals" Filterable="true" FilterMode="@DataGridFilterMode.ColumnFilterRow" SortMode="SortMode.Single">
        <Columns>
            <PropertyColumn Property="x => x.Date" Title="Date" Sortable="false">
                <FilterTemplate>
                    <MudStack Row="true" Justify="Justify.FlexStart" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body1">@ViewModel.CurrentDate?.ToString("M/d/yyyy")</MudText>
                        <MudIconButton OnClick="@OpenDateFilter" Icon="@Icons.Material.Outlined.FilterAlt" Size="@Size.Small" /> 
                    </MudStack>
                    <MudOverlay Visible="_dateFilterOpen" LightBackground="false" OnClick="@(() => _dateFilterOpen = false)" />
                    <MudPopover Open="@_dateFilterOpen" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopCenter" Style="">
                        <MudStack Spacing="0">
                            <MudDatePicker 
                                DateChanged="FilterDateChanged" 
                                @ref="_datePicker"
                                MaxDate="ViewModel.MaxDate"
                                MinDate="ViewModel.MinDate"
                                PickerVariant="PickerVariant.Static"
                                 />
                            <MudStack Row="true" Justify="Justify.Center">
                                <MudButton OnClick="@(() => _dateFilterOpen = false)" FullWidth="true">Cancel</MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPopover>
                </FilterTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.State" Title="State" Sortable="true">
                <FilterTemplate>
                    <MudStack Row="true" Justify="Justify.FlexStart" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body1">@_stateFilterFriendlyName</MudText>
                        <MudIconButton OnClick="@(() => _stateFilterOpen = true)" Icon="@Icons.Material.Outlined.FilterAlt" Size="@Size.Small" />
                        <MudIconButton OnClick="@(() => ClearStateFilterAsync(context))" Icon="@Icons.Material.Filled.FilterAltOff" Size="@Size.Small" />
                    </MudStack>
                    <MudOverlay Visible="_stateFilterOpen" LightBackground="false" OnClick="@(() => _stateFilterOpen = false)" />
                    <MudPopover Open="@_stateFilterOpen" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" Style="width:150px">
                        <MudStack Spacing="0">
                            <MudCheckBox T="bool" Label="Select All" Size="@Size.Small" Value="@_selectAll" ValueChanged="@StateFilterSelectAllClicked" />
                            <MudStack Spacing="0" Style="overflow-y:auto;max-height:250px">
                                @foreach (var item in context.Items)
                                {
                                    <MudCheckBox T="bool" Label="@($"{item.State}")" Size="@Size.Small" Value="@(_selectedItems.Contains(item.State))"
                                                 ValueChanged="@((value) => StateFilterSelectedChanged(value, item.State))" />
                                }
                            </MudStack>
                            <MudStack Row="true">
                                <MudButton OnClick="@(() => ClearStateFilterAsync(context))">Clear</MudButton>
                                <MudButton Color="@Color.Primary" OnClick="@(() => ApplyStateFilterAsync(context))">Filter</MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPopover>
                </FilterTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.TotalCases" Format="N0" Title="Total" Sortable="true" Filterable="true" />
            <PropertyColumn Property="x => x.PositiveCases" Format="N0" Title="Positive" Sortable="true" Filterable="true" />
            <PropertyColumn Property="x => x.NegativeCases" Format="N0" Title="Negative" Sortable="true" Filterable="true" />
            <PropertyColumn Property="x => x.HospitalizationRate" Format="P2" Title="Hospitalization Rates" Sortable="true" Filterable="true" />
        </Columns>
        <LoadingContent>
            <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center">
                <MudIcon Size="Size.Large" Icon="@Icons.Material.Outlined.EventNote"/>
                <MudText Typo="Typo.h4">Retrieving Covid Data...</MudText>
            </MudStack>
        </LoadingContent>
        <NoRecordsContent>
            <MudText>No records found. Please check your filter settings.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudDataGridPager T="StateDailyTotalViewModel" />
        </PagerContent>
    </MudDataGrid>

    <MudText Typo="Typo.caption">Data provided by covidstatistics.com</MudText> 
</MudStack>


@code
{
    [Parameter]
    public DateTime? PageDateFilter { get; set; }

    MudDataGrid<StateDailyTotalViewModel>? _dataGrid;
    MudDatePicker? _datePicker;
    HashSet<string> _selectedItems = new();
    HashSet<string> _filterItems = new();
    FilterDefinition<StateDailyTotalViewModel> _filterDefinition = new();
    bool _loading = false;
    bool _stateFilterOpen = false;
    bool _dateFilterOpen = false;
    bool _selectAll = true;
    string _stateFilterFriendlyName = "All";

    protected override void OnParametersSet()
    {
        if(PageDateFilter.HasValue)
        {
            ViewModel.CurrentDate = PageDateFilter.Value;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            _loading = true;
            StateHasChanged();
            await ViewModel.LoadSummaryData();
            await ViewModel.LoadDailyData();
            _loading = false;

            _selectedItems = ViewModel.States.ToHashSet();
            _filterItems = ViewModel.States.ToHashSet();
            _filterDefinition = new FilterDefinition<StateDailyTotalViewModel> { FilterFunction = x => _filterItems.Contains(x.State) };

            // Set the default sort on the datagrid
            await _dataGrid!.SetSortAsync("PositiveCases", SortDirection.Descending, x => x.PositiveCases, new MudBlazor.Utilities.NaturalComparer());

            StateHasChanged();
        }

        base.OnAfterRender(firstRender);
    }

    async Task FilterDateChanged(DateTime? newDate)
    {
        if (newDate?.Date != ViewModel.CurrentDate?.Date)
        {
            ViewModel.CurrentDate = newDate;
            _loading = true;
            StateHasChanged();
            await ViewModel.LoadDailyData();
            var filterDefinitions = _dataGrid!.FilterDefinitions;
            _loading = false;
            _dateFilterOpen = false;
        }
    }

    async Task OpenDateFilter()
    {
        _dateFilterOpen = true;

        do // Need to wait for the datepicker to be shown before scrolling to the selected date (alway need at least 1 delay)
        {
            await Task.Delay(10);
        } while (_datePicker == null);

        if (ViewModel.CurrentDate.HasValue)
        {
            await _datePicker.GoToDate(ViewModel.CurrentDate.Value);
            StateHasChanged();
        }
    }

    async Task ApplyStateFilterAsync(FilterContext<StateDailyTotalViewModel> context)
    {
        _filterItems = _selectedItems.ToHashSet();
        SetStateFilterLabel();
        await context.Actions.ApplyFilterAsync(_filterDefinition);
        _stateFilterOpen = false;
    }

    async Task ClearStateFilterAsync(FilterContext<StateDailyTotalViewModel> context)
    {
        _selectedItems = ViewModel.States.ToHashSet();
        _filterItems = ViewModel.States.ToHashSet();
        SetStateFilterLabel();
        await context.Actions.ClearFilterAsync(_filterDefinition);
        _stateFilterOpen = false;
    }

    void SetStateFilterLabel()
    {
        var totalItems = ViewModel.DailyTotals!.Count;
        switch (_filterItems.Count)
        {
            case var filterCount when filterCount == totalItems:
                _stateFilterFriendlyName = "All";
                break;
            case 0:
                _stateFilterFriendlyName = "No States Selected";
                break;
            case 1:
                _stateFilterFriendlyName = _filterItems.First();
                break;
            case var fc when fc <= 4:
                _stateFilterFriendlyName = string.Join(",", _filterItems);
                break;
            case > 4:
                _stateFilterFriendlyName = "Multiple";
                break;
            default:
                _stateFilterFriendlyName = "Unknown";
                break;
        }
    }

    void StateFilterSelectedChanged(bool isAdd, string state)
    {
        if (isAdd)
        {
            _selectedItems.Add(state);
        }
        else
        {
            _selectedItems.Remove(state);
        }

        _selectAll = (_selectedItems.Count == ViewModel.States.Count());
    }

    void StateFilterSelectAllClicked(bool isSelectAllChecked)
    {
        _selectAll = isSelectAllChecked;

        if (isSelectAllChecked)
        {
            _selectedItems = ViewModel.States.ToHashSet();
        }
        else
        {
            _selectedItems.Clear();
        }
    }
}
